<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HasÄ±lat Takip AracÄ± â€” OCR â†’ Excel</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

</head>
<body>
  <h2>ğŸ“¦ HaftalÄ±k Stok Ä°ÅŸleme Sistemi</h2>
<p>FotoÄŸraflarÄ± Google Lens ile metne Ã§evir â†’ buraya yÃ¼kle</p>
<hr>

<h3>ğŸ“¥ Fatura YÃ¼kle (OKUL GiriÅŸ)</h3>
<input type="file" accept=".txt" onchange="processImage(this.files[0], 'okul_gelen')">

<h3>ğŸšš KÄ±z Yurdu Ã‡Ä±kÄ±ÅŸ</h3>
<input type="file" accept=".txt" onchange="processImage(this.files[0], 'kiz_cikis')">

<h3>ğŸšš Erkek Yurdu Ã‡Ä±kÄ±ÅŸ</h3>
<input type="file" accept=".txt" onchange="processImage(this.files[0], 'erkek_cikis')">

<h3>ğŸ“· Okul Kalan</h3>
<input type="file" accept=".txt" onchange="processImage(this.files[0], 'okul_kalan')">

<h3>ğŸ“· KÄ±z Yurt Kalan</h3>
<input type="file" accept=".txt" onchange="processImage(this.files[0], 'kiz_kalan')">

<h3>ğŸ“· Erkek Yurt Kalan</h3>
<input type="file" accept=".txt" onchange="processImage(this.files[0], 'erkek_kalan')">

<hr>
<button onclick="downloadExcel()">ğŸ“Š Excel OluÅŸtur</button>

  <header>
    <h1>HasÄ±lat Takip AracÄ±</h1>
    <p class="muted">FotoÄŸraf yÃ¼kle â†’ OCR Ã§alÄ±ÅŸsÄ±n â†’ Metni dÃ¼zelt â†’ Excel indir. (TarayÄ±cÄ± iÃ§inde, veri dÄ±ÅŸarÄ± Ã§Ä±kmaz.)</p>
  </header>

  <main>
    <section class="card">
      <label class="label">1) FotoÄŸraflarÄ± seÃ§ (fatura / kalan stok fotoÄŸraflarÄ±)</label>
      <input id="files" type="file" accept="image/*" multiple>
      <div id="fileNames" class="file-names">HenÃ¼z dosya seÃ§ilmedi.</div>
      <div class="buttons">
        <button id="startOcr">ğŸ” OCR Yap</button>
        <button id="clearAll" class="secondary">Temizle</button>
        <button id="downloadSample" class="secondary">Ã–rnek Åablon Ä°ndir</button>
      </div>
      <div id="progress" class="progress"></div>
    </section>

    <section class="card">
      <label class="label">2) OCR Sonucu (inceleyip dÃ¼zenleyin)</label>
      <textarea id="rawText" placeholder="OCR sonuÃ§larÄ± burada gÃ¶rÃ¼necek. Manuel dÃ¼zeltme yapabilirsiniz."></textarea>
      <div class="hint">Not: OCR satÄ±rlarÄ± Ã¼rÃ¼n bazlÄ± olmayabilir, dÃ¼zenleyip satÄ±r satÄ±r "ÃœRÃœN - MÄ°KTAR - BÄ°RÄ°M FÄ°YAT" formatÄ±na getirin.</div>
      <div class="buttons">
        <button id="buildExcel">â¬‡ï¸ Excel OluÅŸtur ve Ä°ndir</button>
      </div>
    </section>

    <section class="card small">
      <label class="label">3) Log / Durum</label>
      <div id="log" class="log">HazÄ±r.</div>
    </section>
  </main>

  <footer>
    <small>GeliÅŸmiÅŸ OCR (PDF, yÃ¼ksek doÄŸruluk) istersen Google Vision veya arka uÃ§ gerekir â€” istersen bunu da kurarÄ±z.</small>
  </footer>

  <!-- CDN'ler: Tesseract.js ve SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // Elemanlar
    const filesInput = document.getElementById('files');
    const fileNamesEl = document.getElementById('fileNames');
    const startBtn = document.getElementById('startOcr');
    const rawText = document.getElementById('rawText');
    const logEl = document.getElementById('log');
    const progressEl = document.getElementById('progress');
    const buildExcelBtn = document.getElementById('buildExcel');
    const clearBtn = document.getElementById('clearAll');
    const downloadSampleBtn = document.getElementById('downloadSample');

    let files = [];

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logEl.innerHTML = `<div>[${now}] ${msg}</div>` + logEl.innerHTML;
    }

    filesInput.addEventListener('change', (e) => {
      files = Array.from(e.target.files);
      if (!files.length) {
        fileNamesEl.textContent = 'HenÃ¼z dosya seÃ§ilmedi.';
        return;
      }
      fileNamesEl.textContent = files.map(f => f.name).join(', ');
      log(`${files.length} dosya seÃ§ildi.`);
    });

    clearBtn.addEventListener('click', () => {
      filesInput.value = '';
      files = [];
      fileNamesEl.textContent = 'HenÃ¼z dosya seÃ§ilmedi.';
      rawText.value = '';
      log('Temizlendi.');
    });

    downloadSampleBtn.addEventListener('click', () => {
      const wb = XLSX.utils.book_new();
      const header = [["ÃœrÃ¼n AdÄ±","Miktar","Birim Fiyat","Tutar"]];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(header), "Faturalar");
      XLSX.writeFile(wb, "HAFTALIK_HASILAT_Ã¶rnek.xlsx");
    });

    async function fileToImage(file) {
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function ocrImage(file, idx, total) {
      progressEl.textContent = `(${idx}/${total}) OCR: ${file.name}`;
      log(`OCR baÅŸlatÄ±ldÄ±: ${file.name}`);
      const img = await fileToImage(file);
      const { data: { text } } = await Tesseract.recognize(img, 'tur', {
        logger: m => {
          if (m.status === 'recognizing text' && typeof m.progress === 'number') {
            const p = Math.round(m.progress * 100);
            progressEl.textContent = `(${idx}/${total}) ${file.name} â€” OCR %${p}`;
          }
        }
      });
      log(`OCR tamamlandÄ±: ${file.name}`);
      return `==== ${file.name} ====\n${text}\n`;
    }

    startBtn.addEventListener('click', async () => {
      if (!files.length) { alert('Ã–nce fotoÄŸraf seÃ§in.'); return; }
      startBtn.disabled = true;
      rawText.value = '';
      log('TÃ¼m dosyalar iÃ§in OCR baÅŸlÄ±yor...');
      let combined = '';
      for (let i = 0; i < files.length; ++i) {
        try {
          const out = await ocrImage(files[i], i+1, files.length);
          combined += out + "\n";
          rawText.value = combined;
        } catch (e) {
          log('OCR hatasÄ±: ' + (e.message || e));
        }
      }
      progressEl.textContent = 'OCR tamamlandÄ±.';
      log('TÃ¼m OCR iÅŸlemleri tamamlandÄ±. Metni kontrol edip dÃ¼zeltin, sonra Excel oluÅŸturun.');
      startBtn.disabled = false;
    });

    // Basit ayrÄ±ÅŸtÄ±rÄ±cÄ±: her satÄ±rÄ± Ã¼rÃ¼n, miktar, fiyat arar
    function parseLinesToRows(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const rows = [];
      for (let l of lines) {
        // ignore headers like ==== filename ====
        if (/^=+/.test(l)) continue;
        // fiyat arama (virgÃ¼l veya nokta)
        let priceMatch = l.match(/(\d{1,3}(?:[.,]\d{2,3})?)\s*(TL|TRY)?$/i);
        let price = priceMatch ? priceMatch[1].replace(',', '.') : '';
        // miktar arama (Ã¶r: 8PK, 4KL, 16SR, 360 adet, 27)
        let qtyMatch = l.match(/(\d+)\s*(adet|ad|pk|kl|sr|koli|adetleri)?\b/i) || l.match(/(\d+)\b(?!.*\d)/);
        let qty = qtyMatch ? qtyMatch[1] : '';
        // Ã¼rÃ¼n adÄ±: miktar ve fiyat parÃ§alarÄ±nÄ± kaldÄ±r
        let name = l;
        if (priceMatch) name = name.replace(priceMatch[0], '').trim();
        if (qtyMatch) name = name.replace(qtyMatch[0], '').trim();
        // temizle
        name = name.replace(/(^\W+|\W+$)/g, '').trim();
        if (name && (price || qty)) {
          rows.push({
            product: name,
            quantity: qty ? parseInt(qty) : '',
            unitPrice: price ? parseFloat(price) : ''
          });
        }
      }
      return rows;
    }

    function rowsToExcel(rows) {
      const wb = XLSX.utils.book_new();
      const header = ["ÃœrÃ¼n AdÄ±","Miktar","Birim Fiyat","Tutar"];
      const aoa = [header];
      rows.forEach(r => {
        const t = (r.quantity && r.unitPrice) ? (r.quantity * r.unitPrice) : "";
        aoa.push([r.product, r.quantity, r.unitPrice, t]);
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), "Faturalar");
      // AyrÄ±ca ham metni ayrÄ± sheet'e koy
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["Ham OCR Metni"],[rawText.value]]), "OCR_Raw");
      const ts = new Date().toISOString().slice(0,10);
      const filename = `HAFTALIK_HASILAT_${ts}.xlsx`;
      XLSX.writeFile(wb, filename);
      log(`${filename} indirildi.`);
    }

    buildExcelBtn.addEventListener('click', () => {
      const text = rawText.value.trim();
      if (!text) { alert('Ã–nce OCR yapÄ±n ya da metin yapÄ±ÅŸtÄ±rÄ±n.'); return; }
      log('Metin ayrÄ±ÅŸtÄ±rÄ±lÄ±yor...');
      const rows = parseLinesToRows(text);
      if (!rows.length) {
        if (!confirm('HiÃ§ satÄ±r ayrÄ±ÅŸtÄ±rÄ±lamadÄ±. Yine de ham metin iÃ§eren bir Excel indirmek ister misiniz?')) return;
      }
      rowsToExcel(rows);
    });

    // BaÅŸlangÄ±Ã§
    log('Uygulama hazÄ±r. FotoÄŸraflarÄ± seÃ§ip "OCR Yap" butonuna basÄ±n.');
  </script>
  <script src="app.js"></script>

</body>
</html>
